<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Model Tuning</title>
    <meta charset="utf-8" />
    <meta name="author" content="Emil Hvitfeldt" />
    <meta name="date" content="2021-11-02" />
    <!--radix_placeholder_navigation_in_header-->
    <meta name="distill:offset" content=""/>

    <script type="application/javascript">

      window.headroom_prevent_pin = false;

      window.document.addEventListener("DOMContentLoaded", function (event) {

        // initialize headroom for banner
        var header = $('header').get(0);
        var headerHeight = header.offsetHeight;
        var headroom = new Headroom(header, {
          tolerance: 5,
          onPin : function() {
            if (window.headroom_prevent_pin) {
              window.headroom_prevent_pin = false;
              headroom.unpin();
            }
          }
        });
        headroom.init();
        if(window.location.hash)
          headroom.unpin();
        $(header).addClass('headroom--transition');

        // offset scroll location for banner on hash change
        // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
        window.addEventListener("hashchange", function(event) {
          window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
        });

        // responsive menu
        $('.distill-site-header').each(function(i, val) {
          var topnav = $(this);
          var toggle = topnav.find('.nav-toggle');
          toggle.on('click', function() {
            topnav.toggleClass('responsive');
          });
        });

        // nav dropdowns
        $('.nav-dropbtn').click(function(e) {
          $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
          $(this).parent().siblings('.nav-dropdown')
             .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
        });
        $("body").click(function(e){
          $('.nav-dropdown-content').removeClass('nav-dropdown-active');
        });
        $(".nav-dropdown").click(function(e){
          e.stopPropagation();
        });
      });
    </script>

    <style type="text/css">

    /* Theme (user-documented overrideables for nav appearance) */

    .distill-site-nav {
      color: rgba(255, 255, 255, 0.8);
      background-color: #0F2E3D;
      font-size: 15px;
      font-weight: 300;
    }

    .distill-site-nav a {
      color: inherit;
      text-decoration: none;
    }

    .distill-site-nav a:hover {
      color: white;
    }

    @media print {
      .distill-site-nav {
        display: none;
      }
    }

    .distill-site-header {

    }

    .distill-site-footer {

    }


    /* Site Header */

    .distill-site-header {
      width: 100%;
      box-sizing: border-box;
      z-index: 3;
    }

    .distill-site-header .nav-left {
      display: inline-block;
      margin-left: 8px;
    }

    @media screen and (max-width: 768px) {
      .distill-site-header .nav-left {
        margin-left: 0;
      }
    }


    .distill-site-header .nav-right {
      float: right;
      margin-right: 8px;
    }

    .distill-site-header a,
    .distill-site-header .title {
      display: inline-block;
      text-align: center;
      padding: 14px 10px 14px 10px;
    }

    .distill-site-header .title {
      font-size: 18px;
      min-width: 150px;
    }

    .distill-site-header .logo {
      padding: 0;
    }

    .distill-site-header .logo img {
      display: none;
      max-height: 20px;
      width: auto;
      margin-bottom: -4px;
    }

    .distill-site-header .nav-image img {
      max-height: 18px;
      width: auto;
      display: inline-block;
      margin-bottom: -3px;
    }



    @media screen and (min-width: 1000px) {
      .distill-site-header .logo img {
        display: inline-block;
      }
      .distill-site-header .nav-left {
        margin-left: 20px;
      }
      .distill-site-header .nav-right {
        margin-right: 20px;
      }
      .distill-site-header .title {
        padding-left: 12px;
      }
    }


    .distill-site-header .nav-toggle {
      display: none;
    }

    .nav-dropdown {
      display: inline-block;
      position: relative;
    }

    .nav-dropdown .nav-dropbtn {
      border: none;
      outline: none;
      color: rgba(255, 255, 255, 0.8);
      padding: 16px 10px;
      background-color: transparent;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      margin: 0;
      margin-top: 1px;
      z-index: 2;
    }

    .nav-dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 200px;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 4px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
      z-index: 1;
      margin-top: 2px;
      white-space: nowrap;
      padding-top: 4px;
      padding-bottom: 4px;
    }

    .nav-dropdown-content hr {
      margin-top: 4px;
      margin-bottom: 4px;
      border: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .nav-dropdown-active {
      display: block;
    }

    .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
      color: black;
      padding: 6px 24px;
      text-decoration: none;
      display: block;
      text-align: left;
    }

    .nav-dropdown-content .nav-dropdown-header {
      display: block;
      padding: 5px 24px;
      padding-bottom: 0;
      text-transform: uppercase;
      font-size: 14px;
      color: #999999;
      white-space: nowrap;
    }

    .nav-dropdown:hover .nav-dropbtn {
      color: white;
    }

    .nav-dropdown-content a:hover {
      background-color: #ddd;
      color: black;
    }

    .nav-right .nav-dropdown-content {
      margin-left: -45%;
      right: 0;
    }

    @media screen and (max-width: 768px) {
      .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
      .distill-site-header a.nav-toggle {
        float: right;
        display: block;
      }
      .distill-site-header .title {
        margin-left: 0;
      }
      .distill-site-header .nav-right {
        margin-right: 0;
      }
      .distill-site-header {
        overflow: hidden;
      }
      .nav-right .nav-dropdown-content {
        margin-left: 0;
      }
    }


    @media screen and (max-width: 768px) {
      .distill-site-header.responsive {position: relative; min-height: 500px; }
      .distill-site-header.responsive a.nav-toggle {
        position: absolute;
        right: 0;
        top: 0;
      }
      .distill-site-header.responsive a,
      .distill-site-header.responsive .nav-dropdown {
        display: block;
        text-align: left;
      }
      .distill-site-header.responsive .nav-left,
      .distill-site-header.responsive .nav-right {
        width: 100%;
      }
      .distill-site-header.responsive .nav-dropdown {float: none;}
      .distill-site-header.responsive .nav-dropdown-content {position: relative;}
      .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
        display: block;
        width: 100%;
        text-align: left;
      }
    }

    /* Site Footer */

    .distill-site-footer {
      width: 100%;
      overflow: hidden;
      box-sizing: border-box;
      z-index: 3;
      margin-top: 30px;
      padding-top: 30px;
      padding-bottom: 30px;
      text-align: center;
    }

    /* Headroom */

    d-title {
      padding-top: 6rem;
    }

    @media print {
      d-title {
        padding-top: 4rem;
      }
    }

    .headroom {
      z-index: 1000;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }

    .headroom--transition {
      transition: all .4s ease-in-out;
    }

    .headroom--unpinned {
      top: -100px;
    }

    .headroom--pinned {
      top: 0;
    }

    /* adjust viewport for navbar height */
    /* helps vertically center bootstrap (non-distill) content */
    .min-vh-100 {
      min-height: calc(100vh - 100px) !important;
    }

    </style>

    <script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
    <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
    <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
    <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
    <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

    <script type="application/javascript">

    function getMeta(metaName) {
      var metas = document.getElementsByTagName('meta');
      for (let i = 0; i < metas.length; i++) {
        if (metas[i].getAttribute('name') === metaName) {
          return metas[i].getAttribute('content');
        }
      }
      return '';
    }

    function offsetURL(url) {
      var offset = getMeta('distill:offset');
      return offset ? offset + '/' + url : url;
    }

    function createFuseIndex() {

      // create fuse index
      var options = {
        keys: [
          { name: 'title', weight: 20 },
          { name: 'categories', weight: 15 },
          { name: 'description', weight: 10 },
          { name: 'contents', weight: 5 },
        ],
        ignoreLocation: true,
        threshold: 0
      };
      var fuse = new window.Fuse([], options);

      // fetch the main search.json
      return fetch(offsetURL('search.json'))
        .then(function(response) {
          if (response.status == 200) {
            return response.json().then(function(json) {
              // index main articles
              json.articles.forEach(function(article) {
                fuse.add(article);
              });
              // download collections and index their articles
              return Promise.all(json.collections.map(function(collection) {
                return fetch(offsetURL(collection)).then(function(response) {
                  if (response.status === 200) {
                    return response.json().then(function(articles) {
                      articles.forEach(function(article) {
                        fuse.add(article);
                      });
                    })
                  } else {
                    return Promise.reject(
                      new Error('Unexpected status from search index request: ' +
                                response.status)
                    );
                  }
                });
              })).then(function() {
                return fuse;
              });
            });

          } else {
            return Promise.reject(
              new Error('Unexpected status from search index request: ' +
                          response.status)
            );
          }
        });
    }

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // get search element (bail if we don't have one)
      var searchEl = window.document.getElementById('distill-search');
      if (!searchEl)
        return;

      createFuseIndex()
        .then(function(fuse) {

          // make search box visible
          searchEl.classList.remove('hidden');

          // initialize autocomplete
          var options = {
            autoselect: true,
            hint: false,
            minLength: 2,
          };
          window.autocomplete(searchEl, options, [{
            source: function(query, callback) {
              const searchOptions = {
                isCaseSensitive: false,
                shouldSort: true,
                minMatchCharLength: 2,
                limit: 10,
              };
              var results = fuse.search(query, searchOptions);
              callback(results
                .map(function(result) { return result.item; })
              );
            },
            templates: {
              suggestion: function(suggestion) {
                var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                  ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                  : '';
                var html = `
                  <div class="search-item">
                    <h3>${suggestion.title}</h3>
                    <div class="search-item-description">
                      ${suggestion.description || ''}
                    </div>
                    <div class="search-item-preview">
                      ${img}
                    </div>
                  </div>
                `;
                return html;
              }
            }
          }]).on('autocomplete:selected', function(event, suggestion) {
            window.location.href = offsetURL(suggestion.path);
          });
          // remove inline display style on autocompleter (we want to
          // manage responsive display via css)
          $('.algolia-autocomplete').css("display", "");
        })
        .catch(function(error) {
          console.log(error);
        });

    });

    </script>

    <style type="text/css">

    .nav-search {
      font-size: x-small;
    }

    /* Algolioa Autocomplete */

    .algolia-autocomplete {
      display: inline-block;
      margin-left: 10px;
      vertical-align: sub;
      background-color: white;
      color: black;
      padding: 6px;
      padding-top: 8px;
      padding-bottom: 0;
      border-radius: 6px;
      border: 1px #0F2E3D solid;
      width: 180px;
    }


    @media screen and (max-width: 768px) {
      .distill-site-nav .algolia-autocomplete {
        display: none;
        visibility: hidden;
      }
      .distill-site-nav.responsive .algolia-autocomplete {
        display: inline-block;
        visibility: visible;
      }
      .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
        margin-left: 0;
        width: 400px;
        max-height: 400px;
      }
    }

    .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
      width: 90%;
      outline: none;
      border: none;
    }

    .algolia-autocomplete .aa-hint {
      color: #999;
    }
    .algolia-autocomplete .aa-dropdown-menu {
      width: 550px;
      max-height: 70vh;
      overflow-x: visible;
      overflow-y: scroll;
      padding: 5px;
      margin-top: 3px;
      margin-left: -150px;
      background-color: #fff;
      border-radius: 5px;
      border: 1px solid #999;
      border-top: none;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
      cursor: pointer;
      padding: 5px 4px;
      border-bottom: 1px solid #eee;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
      border-bottom: none;
      margin-bottom: 2px;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
      overflow: hidden;
      font-size: 0.8em;
      line-height: 1.4em;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
      font-size: 1rem;
      margin-block-start: 0;
      margin-block-end: 5px;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
      display: inline-block;
      overflow: hidden;
      height: 2.8em;
      width: 80%;
      margin-right: 4%;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
      display: inline-block;
      width: 15%;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
      height: 3em;
      width: auto;
      display: none;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
      display: initial;
    }

    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
      background-color: #eee;
    }
    .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
      font-weight: bold;
      font-style: normal;
    }

    </style>


    <!--/radix_placeholder_navigation_in_header-->
    <!--radix_placeholder_site_in_header-->
    <style type="text/css">
    .distill-site-nav {
        background-color: #1D1E1A;
    }

    </style>
    <!--/radix_placeholder_site_in_header-->
    
    <style type="text/css">
    body {
      padding-top: 60px;
    }
    </style>
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/countdown-0.3.5/countdown.css" rel="stylesheet" />
    <script src="libs/countdown-0.3.5/countdown.js"></script>
    <link rel="stylesheet" href="setup/theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

# Model Tuning
## NHS-R Conference 2021
### Emil Hvitfeldt
### 2021-11-02

---

<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">NHS tidymodels workshop</a>
</div>
<div class="nav-right">
<a href="index.html">Home</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Slides
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="1-introduction.html">1: Introduction</a>
<hr/>
<a href="2-models.html">2: Models</a>
<hr/>
<a href="3-features.html">3: Features</a>
<hr/>
<a href="4-resampling.html">4: Resampling</a>
<hr/>
<a href="5-tuning.html">5: Tuning</a>
</div>
</div>
<a href="https://github.com/EmilHvitfeldt/nhs-tidymodels-workshop">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

class: inverse, middle, center



&lt;!--- Packages ---------------------------------------------------------------&gt;






&lt;!--- Chunk options ----------------------------------------------------------&gt;



&lt;!--- pkg highlight ----------------------------------------------------------&gt;

&lt;style&gt;
.pkg {  
  font-weight: bold;
  letter-spacing: 0.5pt;
  color: #866BBF;
}
&lt;/style&gt;

&lt;!--- Highlighing colors -----------------------------------------------------&gt;



&lt;div style = "position:fixed; visibility: hidden"&gt;
`$$\require{color}\definecolor{purple}{rgb}{0.525490196078431, 0.419607843137255, 0.749019607843137}$$`
`$$\require{color}\definecolor{green}{rgb}{0.0117647058823529, 0.650980392156863, 0.415686274509804}$$`
`$$\require{color}\definecolor{orange}{rgb}{0.949019607843137, 0.580392156862745, 0.254901960784314}$$`
`$$\require{color}\definecolor{white}{rgb}{1, 1, 1}$$`
&lt;/div&gt;

&lt;script type="text/x-mathjax-config"&gt;
MathJax.Hub.Config({
  TeX: {
    Macros: {
      purple: ["{\\color{purple}{#1}}", 1],
      green: ["{\\color{green}{#1}}", 1],
      orange: ["{\\color{orange}{#1}}", 1],
      white: ["{\\color{white}{#1}}", 1]
    },
    loader: {load: ['[tex]/color']},
    tex: {packages: {'[+]': ['color']}}
  }
});
&lt;/script&gt;

&lt;style&gt;
.purple {color: #866BBF;}
.green {color: #03A66A;}
.orange {color: #F29441;}
.white {color: #FFFFFF;}
&lt;/style&gt;




&lt;!--- knitr hooks ------------------------------------------------------------&gt;





# [`tidymodels.org`](https://www.tidymodels.org/)

# _Tidy Modeling with R_ ([`tmwr.org`](https://www.tmwr.org/))

---

# Tuning parameters

These are model or preprocessing parameters that are important but cannot be estimated directly form the data. 

Some examples:

.pull-left[

* Tree depth in decision trees.

* Number of neighbors in a K-nearest neighbor model. 

* Activation function (e.g. sigmoidal, ReLu) in neural networks. 

* Number of PCA components to retain

]
.pull-right[

* Covariance/correlation matrix structure in mixed models.

* Data distribution in survival models.

* Spline degrees of freedom. 
]

---

# Optimizng tuning parameters

The main approach is to try different values and measure their performance. This can lead us to good values for these parameters. 

The main two classes of optimization models are: 

 * _Grid search_ where a pre-defined set of candidate values are tested. 
 
 
 * _Iterative search_ methods suggest/estimate new values of candidate parameters to evaluate. 

Once the value(s) of the parameter(s) are determine, a model can be finalized but fitting the model to the entire training set. 

---

# Measuring tuning paramters

We need performance metrics to tell us which candidate values are good and which are not. 

Using the test set, or simply re-predicting the training set, are very bad ideas. 

Since tuning parameters often control complexity, they can often lead to [_overfitting_](https://www.tmwr.org/tuning.html#overfitting-bad). 

* This is where the model does very well on the training set but poorly on new data. 

Using _resampling_ to estimate performance can help identify parameters that lead to overfitting. 

The cost is computational time. 

---

# Overfitting with a support vector machine

&lt;img src="5-tuning_files/figure-html/overfitting-1.svg" width="60%" style="display: block; margin: auto;" /&gt;

---

# Choosing tuning parameters

Let's take our previous model and add a few changes:


```r
lm_spec &lt;- 
  linear_reg() %&gt;% 
  set_engine("lm")

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_numeric_predictors()) %&gt;% 
  step_corr(all_numeric_predictors(), threshold = 0.9)

chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Use regularizaed regression


```r
lm_spec &lt;- 
  linear_reg() %&gt;% 
  set_engine("glmnet") #&lt;&lt;

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_numeric_predictors()) %&gt;% 
  step_corr(all_numeric_predictors(), threshold = 0.9)

chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Add model parameters


```r
lm_spec &lt;- 
  linear_reg(penalty, mixture) %&gt;% #&lt;&lt;
  set_engine("glmnet") 

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_numeric_predictors()) %&gt;% 
  step_corr(all_numeric_predictors(), threshold = 0.9)

chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Mark them for tuning


```r
lm_spec &lt;- 
  linear_reg(penalty = tune(), mixture = tune()) %&gt;% #&lt;&lt;
  set_engine("glmnet") 

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_numeric_predictors()) %&gt;% 
  step_corr(all_numeric_predictors(), threshold = 0.9)

chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Remove unneeded step


```r
lm_spec &lt;- 
  linear_reg(penalty = tune(), mixture = tune()) %&gt;% 
  set_engine("glmnet") 

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_normalize(all_numeric_predictors())


chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Add a spline step (just for demonstration)



```r
lm_spec &lt;- 
  linear_reg(penalty = tune(), mixture = tune()) %&gt;% 
  set_engine("glmnet") 

chi_rec &lt;- 
  recipe(ridership ~ ., data = chi_train) %&gt;% 
  step_date(date, features = c("dow", "year")) %&gt;% 
  step_holiday(date) %&gt;% 
  update_role(date, new_role = "id") %&gt;% 
  step_dummy(all_nominal_predictors()) %&gt;% 
  step_zv(all_predictors()) %&gt;% 
  step_ns(temp, deg_free = tune()) %&gt;%  #&lt;&lt;
  step_normalize(all_numeric_predictors())

chi_wflow &lt;- 
  workflow() %&gt;% 
  add_model(lm_spec) %&gt;% 
  add_recipe(chi_rec)
```

---

# Grid search

This is the most basic (but very effective) way for tuning models. 

tidymodels has pre-defined information on tuning parameters, such as their type, range, transformations, etc. 

A grid can be created manually or automatically. 

The `parameters()` function extracts the tuning parameters and the info. 

The `grid_*()` functions can make a grid. 

---

# Manual grid - get parameters

.pull-left[

```r
chi_wflow %&gt;% 
  parameters()
```
This type of object can be updated (e.g. to change the ranges, etc)

]
.pull-right[

```
## Collection of 3 parameters for tuning
## 
##  identifier     type    object
##     penalty  penalty nparam[+]
##     mixture  mixture nparam[+]
##    deg_free deg_free nparam[+]
```
]

---

# Manual grid - create grid

.pull-left[

```r
set.seed(2)
grid &lt;- 
  chi_wflow %&gt;% 
  parameters() %&gt;% 
  grid_latin_hypercube(size = 25)

grid
```

This is a type of _space-filling design_. 

It tends to do much better than random grids and is (usually) more efficient than regular grids. 

]
.pull-right[

```
## # A tibble: 25 × 3
##          penalty mixture deg_free
##            &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt;
##  1 0.124           0.309        2
##  2 0.0000000474    0.269        5
##  3 0.0000000101    0.810        4
##  4 0.0000140       0.527       11
##  5 0.172           0.897        3
##  6 0.0000329       0.701        3
##  7 0.00000000610   0.590       13
##  8 0.0141          0.102        6
##  9 0.00513         0.405       13
## 10 0.000667        0.145        1
## # … with 15 more rows
```
]

---

# The results

.pull-left[

```r
set.seed(2)
grid &lt;- 
  chi_wflow %&gt;% 
  parameters() %&gt;% 
  grid_latin_hypercube(size = 25)

grid %&gt;% 
  ggplot(aes(penalty, mixture, col = deg_free)) + 
  geom_point(cex = 4) + 
  scale_x_log10()
```

Note that `penalty` was generated in log-10 units. 
]

.pull-right[
&lt;img src="5-tuning_files/figure-html/unnamed-chunk-10-1.svg" width="90%" style="display: block; margin: auto;" /&gt;
]

---

# Grid search

The `tune_*()` functions can be used to tune models. 

`tune_grid()` is pretty representative of their syntax (and is similar to `last_fit()`): 


```r
ctrl &lt;- control_grid(save_pred = TRUE)
set.seed(9)
chi_res &lt;- 
  chi_wflow %&gt;% 
  tune_grid(resamples = chi_rs, grid = grid) # 'grid' = integer for automatic grids
chi_res
```

```
## # Tuning results
## # Sliding period resampling 
## # A tibble: 16 × 4
##    splits            id      .metrics          .notes          
##    &lt;list&gt;            &lt;chr&gt;   &lt;list&gt;            &lt;list&gt;          
##  1 &lt;split [5463/14]&gt; Slice01 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  2 &lt;split [5467/14]&gt; Slice02 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  3 &lt;split [5467/14]&gt; Slice03 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  4 &lt;split [5467/14]&gt; Slice04 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  5 &lt;split [5467/14]&gt; Slice05 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  6 &lt;split [5467/14]&gt; Slice06 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  7 &lt;split [5467/14]&gt; Slice07 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  8 &lt;split [5467/14]&gt; Slice08 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
##  9 &lt;split [5467/14]&gt; Slice09 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 10 &lt;split [5467/14]&gt; Slice10 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 11 &lt;split [5467/14]&gt; Slice11 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 12 &lt;split [5467/14]&gt; Slice12 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 13 &lt;split [5467/14]&gt; Slice13 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 14 &lt;split [5467/14]&gt; Slice14 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 15 &lt;split [5467/14]&gt; Slice15 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
## 16 &lt;split [5467/11]&gt; Slice16 &lt;tibble [50 × 7]&gt; &lt;tibble [0 × 1]&gt;
```

---

# Grid results


```r
autoplot(chi_res)
```

&lt;img src="5-tuning_files/figure-html/autoplot-1.svg" width="70%" style="display: block; margin: auto;" /&gt;

---

# ENHANCE


```r
autoplot(chi_res, metric = "rmse")  +
  ylim(c(1.7, 1.85))
```

&lt;img src="5-tuning_files/figure-html/enhacned-1.svg" width="80%" style="display: block; margin: auto;" /&gt;

---

# Returning results


```r
collect_metrics(chi_res)
```

```
## # A tibble: 50 × 9
##      penalty mixture deg_free .metric .estimator  mean     n std_err .config  
##        &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;    
##  1   1.24e-1   0.309        2 rmse    standard   2.11     16  0.266  Preproce…
##  2   1.24e-1   0.309        2 rsq     standard   0.924    16  0.0249 Preproce…
##  3   4.91e-1   0.817        2 rmse    standard   2.95     16  0.402  Preproce…
##  4   4.91e-1   0.817        2 rsq     standard   0.848    16  0.0502 Preproce…
##  5   4.74e-8   0.269        5 rmse    standard   1.74     16  0.241  Preproce…
##  6   4.74e-8   0.269        5 rsq     standard   0.947    16  0.0213 Preproce…
##  7   3.28e-9   0.483        5 rmse    standard   1.74     16  0.241  Preproce…
##  8   3.28e-9   0.483        5 rsq     standard   0.947    16  0.0212 Preproce…
##  9   1.01e-8   0.810        4 rmse    standard   1.72     16  0.241  Preproce…
## 10   1.01e-8   0.810        4 rsq     standard   0.947    16  0.0210 Preproce…
## # … with 40 more rows
```

---

# Returning results


```r
collect_metrics(chi_res, summarize = FALSE)
```

```
## # A tibble: 800 × 8
##    id      penalty mixture deg_free .metric .estimator .estimate .config      
##    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;        
##  1 Slice01   0.124   0.309        2 rmse    standard       4.20  Preprocessor…
##  2 Slice01   0.124   0.309        2 rsq     standard       0.722 Preprocessor…
##  3 Slice02   0.124   0.309        2 rmse    standard       1.96  Preprocessor…
##  4 Slice02   0.124   0.309        2 rsq     standard       0.961 Preprocessor…
##  5 Slice03   0.124   0.309        2 rmse    standard       2.30  Preprocessor…
##  6 Slice03   0.124   0.309        2 rsq     standard       0.915 Preprocessor…
##  7 Slice04   0.124   0.309        2 rmse    standard       1.78  Preprocessor…
##  8 Slice04   0.124   0.309        2 rsq     standard       0.965 Preprocessor…
##  9 Slice05   0.124   0.309        2 rmse    standard       2.00  Preprocessor…
## 10 Slice05   0.124   0.309        2 rsq     standard       0.938 Preprocessor…
## # … with 790 more rows
```

---

# Metrics over time

.pull-left[

```r
chi_res %&gt;% 
  add_date_to_metrics("date") %&gt;% 
  filter(.metric == "rmse") %&gt;% 
  ggplot(aes(x = date, y = .estimate, 
             group = .config, col = .config)) + 
  geom_line(show.legend = FALSE, alpha = .3) +
  labs(y = "RMSE")
```
]
.pull-right[
&lt;img src="5-tuning_files/figure-html/unnamed-chunk-13-1.svg" width="80%" style="display: block; margin: auto;" /&gt;
]

---

# Picking a parameter combination

You can create a tibble of your own or use one of the `tune::select_*()` functions: 


```r
show_best(chi_res, metric = "rmse")
```

```
## # A tibble: 5 × 9
##    penalty mixture deg_free .metric .estimator  mean     n std_err .config    
##      &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;      
## 1 1.01e- 8   0.810        4 rmse    standard    1.72    16   0.241 Preprocess…
## 2 3.29e- 5   0.701        3 rmse    standard    1.73    16   0.241 Preprocess…
## 3 3.11e- 3   0.869       15 rmse    standard    1.74    16   0.242 Preprocess…
## 4 2.41e- 4   0.949        7 rmse    standard    1.74    16   0.240 Preprocess…
## 5 5.41e-10   0.633        6 rmse    standard    1.74    16   0.241 Preprocess…
```

```r
smallest_rmse &lt;- 
  select_best(chi_res, metric = "rmse")
smallest_rmse
```

```
## # A tibble: 1 × 4
##        penalty mixture deg_free .config              
##          &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;                
## 1 0.0000000101   0.810        4 Preprocessor03_Model1
```

---

# Updating the workflow and final fit


```r
chi_wflow &lt;-
  chi_wflow %&gt;% 
  finalize_workflow(smallest_rmse)

test_res &lt;- 
  chi_wflow %&gt;% 
  last_fit(split = chi_split)
test_res
```

```
## # Resampling results
## # Manual resampling 
## # A tibble: 1 × 6
##   splits            id               .metrics  .notes   .predictions .workflow
##   &lt;list&gt;            &lt;chr&gt;            &lt;list&gt;    &lt;list&gt;   &lt;list&gt;       &lt;list&gt;   
## 1 &lt;split [5684/14]&gt; train/test split &lt;tibble … &lt;tibble… &lt;tibble [14… &lt;workflo…
```

The workflow, fit using the training set:


```r
final_chi_wflow &lt;- 
  test_res$.workflow[[1]]
```

---

# Two-week test set results


```r
collect_metrics(test_res)
```

```
## # A tibble: 2 × 4
##   .metric .estimator .estimate .config             
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
## 1 rmse    standard       0.976 Preprocessor1_Model1
## 2 rsq     standard       0.990 Preprocessor1_Model1
```

```r
# Resampling results
show_best(chi_res, metric = "rmse", n = 1)
```

```
## # A tibble: 1 × 9
##        penalty mixture deg_free .metric .estimator  mean     n std_err .config
##          &lt;dbl&gt;   &lt;dbl&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  
## 1 0.0000000101   0.810        4 rmse    standard    1.72    16   0.241 Prepro…
```

---

# Two-week test set results

.pull-left[

```r
test_res %&gt;% 
  collect_predictions() %&gt;% 
  ggplot(aes(ridership, .pred)) + 
  geom_abline(col = "green", lty = 2) + 
  geom_point(cex = 3, alpha = 0.5) + 
  coord_obs_pred()
```

]

.pull-right[
&lt;img src="5-tuning_files/figure-html/unnamed-chunk-18-1.svg" width="90%" style="display: block; margin: auto;" /&gt;
]

---

# Two-week test set results

.pull-left[

```r
library(lubridate)
test_values &lt;- 
  final_chi_wflow %&gt;% 
  augment(testing(chi_split)) %&gt;% 
  mutate(day = wday(date, label = TRUE)) 

test_values %&gt;% 
  ggplot(aes(ridership, .pred, col = day)) + 
  geom_abline(col = "green", lty = 2) + 
  geom_point(cex = 3, alpha = 0.5) + 
  coord_obs_pred() + 
  scale_color_brewer(palette = "Dark2")
```

]

.pull-right[
&lt;img src="5-tuning_files/figure-html/unnamed-chunk-19-1.svg" width="90%" style="display: block; margin: auto;" /&gt;
]

---

# Two-week test set results

.pull-left[

```r
test_values %&gt;% 
  ggplot(aes(date, ridership)) + 
  geom_point(aes(col = day), 
             cex = 3, alpha = 0.5) +
  geom_line(aes(y = .pred)) + 
  scale_color_brewer(palette = "Dark2")
```

]

.pull-right[
&lt;img src="5-tuning_files/figure-html/unnamed-chunk-20-1.svg" width="100%" style="display: block; margin: auto;" /&gt;
]

---

# Hands-On: Tune hyperparameters

Go to the lab and finish the document by tuning a model

<div class="countdown" id="timer_617fa0e1" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>
    </textarea>
<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="setup/macros.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "arta",
"highlightLanguage": ["r", "css", "yaml"],
"highlightLines": false,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
